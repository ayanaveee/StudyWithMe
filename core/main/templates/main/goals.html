{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<section class="page-section py-5 goals-section" id="goals">
  {% if messages %}
  <div class="mt-3 container">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show auto-dismiss" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
      </div>
    {% endfor %}
  </div>
  <script>
    setTimeout(() => {
      document.querySelectorAll('.auto-dismiss').forEach(alert => {
        alert.classList.remove('show');
        alert.classList.add('fade');
        setTimeout(() => alert.remove(), 500);
      });
    }, 5000);
  </script>
  {% endif %}

  <div class="container px-4 px-lg-5">
    <h2 class="text-center text-uppercase text-white mb-5 fw-bold letter-spacing-1">Цели на неделю</h2>

    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="card mb-5 shadow-lg rounded-4 border-0 goals-form-card">
          <div class="card-body bg-white p-4 p-md-5">
            <form method="post" class="row g-4" novalidate>
              {% csrf_token %}
              <div class="col-12">
                {{ form.title.label_tag }}
                {{ form.title|add_class:"form-control form-control-lg shadow-sm" }}
                {% if form.title.errors %}
                  <div class="text-danger small mt-1">{{ form.title.errors|striptags }}</div>
                {% endif %}
              </div>

              <div class="col-md-6">
                {{ form.category.label_tag }}
                {{ form.category|add_class:"form-select form-select-lg shadow-sm" }}
                {% if form.category.errors %}
                  <div class="text-danger small mt-1">{{ form.category.errors|striptags }}</div>
                {% endif %}
              </div>

              <div class="col-md-6">
                {{ form.deadline.label_tag }}
                {{ form.deadline|add_class:"form-control form-control-lg shadow-sm" }}
                {% if form.deadline.errors %}
                  <div class="text-danger small mt-1">{{ form.deadline.errors|striptags }}</div>
                {% endif %}
              </div>

              <div class="col-md-6">
                {{ form.priority.label_tag }}
                {{ form.priority|add_class:"form-select form-select-lg shadow-sm" }}
                {% if form.priority.errors %}
                  <div class="text-danger small mt-1">{{ form.priority.errors|striptags }}</div>
                {% endif %}
              </div>

              <div class="col-12 text-end">
                <button type="submit" class="btn btn-gradient btn-lg px-5 fw-semibold shadow-sm btn-submit">
                  Добавить цель
                </button>
              </div>
            </form>
          </div>
        </div>

        {% if goals %}
        <div class="list-group goals-list">
          {% for goal in goals %}
            <div class="list-group-item d-flex justify-content-between align-items-center flex-wrap shadow rounded-4 mb-3 goal-item
              {% if goal.priority == 'high' %}priority-high
              {% elif goal.priority == 'medium' %}priority-medium
              {% else %}priority-low{% endif %}">
              <div class="flex-grow-1 me-3 goal-info">
                <h5 class="mb-1 fw-semibold text-dark">{{ goal.title }}</h5>
                <small class="text-muted d-block mb-1">До: {{ goal.deadline|date:"d.m.Y H:i" }}</small>
                <small class="fw-semibold priority-label">
                  Приоритет:
                  {% if goal.priority == 'high' %}
                    <span class="badge bg-danger">Высокий</span>
                  {% elif goal.priority == 'medium' %}
                    <span class="badge bg-warning text-dark">Средний</span>
                  {% else %}
                    <span class="badge bg-secondary">Низкий</span>
                  {% endif %}
                </small>
              </div>

              <div class="d-flex align-items-center gap-2 goal-actions">
                <a href="{% url 'edit_goal' goal.pk %}" class="btn btn-outline-primary btn-sm rounded-circle shadow-sm action-btn" title="Редактировать цель" aria-label="Редактировать">
                  <i class="fas fa-pen"></i>
                </a>

                {% if not goal.is_completed %}
                  <form method="post" action="{% url 'mark_goal_completed' goal.pk %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success btn-sm rounded-circle shadow-sm action-btn" title="Отметить как выполненную" aria-label="Отметить выполненной">
                      <i class="fas fa-check"></i>
                    </button>
                  </form>
                {% else %}
                  <span class="badge bg-success completed-badge">Выполнено</span>
                {% endif %}

                <form method="post" action="{% url 'delete_goal' goal.pk %}" style="display: inline;">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-danger btn-sm rounded-circle shadow-sm action-btn" title="Удалить цель" aria-label="Удалить">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </form>
              </div>
            </div>
          {% endfor %}
        </div>
        {% else %}
          <p class="text-center text-white fst-italic fs-5 mt-4 no-goals-msg">
            <i class="fas fa-bullseye me-2"></i> Целей пока нет. Добавьте первую цель!
          </p>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<style>
  /* Основной фон и отступы */
  .goals-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
  }
  .letter-spacing-1 {
    letter-spacing: 0.15em;
  }

  /* Карточка формы */
  .goals-form-card {
    border-radius: 1rem !important;
    transition: box-shadow 0.3s ease;
  }
  .goals-form-card:hover {
    box-shadow: 0 12px 40px rgba(102, 126, 234, 0.5);
  }

  /* Кнопка отправки */
  .btn-submit {
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    color: #fff;
    border: none;
    border-radius: 0.5rem;
    transition: background-color 0.3s ease, transform 0.15s ease;
  }
  .btn-submit:hover,
  .btn-submit:focus {
    background: linear-gradient(90deg, #5566cc 0%, #5a4a99 100%);
    transform: scale(1.05);
  }

  /* Список целей */
  .goals-list {
    margin-top: 1rem;
  }
  .goal-item {
    background: rgba(255 255 255 / 0.95);
    border-left: 6px solid transparent;
    padding: 1rem 1.25rem;
    transition: box-shadow 0.3s ease, transform 0.2s ease;
    cursor: default;
  }
  .goal-item:hover {
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.35);
    transform: translateY(-3px);
    cursor: pointer;
  }

  /* Цвета приоритетов */
  .priority-high {
    border-left-color: #dc3545 !important; /* красный */
  }
  .priority-medium {
    border-left-color: #ffc107 !important; /* желтый */
  }
  .priority-low {
    border-left-color: #6c757d !important; /* серый */
  }

  /* Информация о цели */
  .goal-info h5 {
    font-weight: 600;
  }
  .priority-label {
    font-size: 0.875rem;
  }

  /* Кнопки действий */
  .goal-actions {
    gap: 0.6rem;
  }
  .action-btn {
    width: 42px;
    height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s ease, color 0.2s ease, transform 0.15s ease;
  }
  .action-btn:hover {
    filter: brightness(0.9);
    transform: scale(1.1);
  }

  /* Выполнено */
  .completed-badge {
    font-size: 0.9rem;
    padding: 0.5em 0.7em;
  }

  /* Сообщение, если целей нет */
  .no-goals-msg {
    font-style: italic;
    font-weight: 500;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .no-goals-msg i {
    font-size: 1.3rem;
    color: #fff;
  }

  /* Адаптив */
  @media (max-width: 575.98px) {
    .goal-item {
      padding: 0.8rem 1rem;
    }
    .goal-actions {
      gap: 0.4rem;
    }
    .action-btn {
      width: 36px;
      height: 36px;
    }
    .btn-submit {
      width: 100%;
      padding-left: 0;
      padding-right: 0;
      font-size: 1.1rem;
    }
  }
</style>

{% endblock %}
